Instructions for signing and installing TPM keys
================================================


This step used the aikblob and the aikhexmod.txt generated in step 5.

Generate a public/private key pair (the "activity policy key").

Create the directory that tcService will find the hardware keys 
and certificates as specified in "DirectoryStructure.txt", 
by default this is ROOT/HWRoot.  In an earlier step, you copied
the aikblob and the aik-hex-file into this directory.

In the executable directory type:
    cd ROOT
    ./cryptUtility.exe -GenKey RSA1024 policyPrivateKey.xml # (for 1024 bit keys)
or
    ./cryptUtility.exe -GenKey RSA2048 policyPrivateKey.xml # (for 2048 bit keys)

Store the policyPrivateKey.xml in ROOT for testing.  You should 
NEVER have the private key on an insecure computer and you should
NEVER lose this key.  This key will be copied onto the 
keyNegoServer Computer later.  Put it in policy/policyPrivateKey.xml

Produce the AIK certificate by typing:
    cd ROOT
    ./cryptUtility.exe -SignHexModulus policyPrivateKey.xml HWRoot/aikhexmod.txt HWRoot/cert

Next produce a self signed cert for the policy key, as follows:

Copy policyPublicProto.xml from this (Doc) directory into ROOT/HWRoot
(for 1024 bit keys) and policyPublicProto2048.xml (for 2048 bit
keys).  Edit the file replacing the CAPITALIZED items.  Then insert
the xml in privatePolicyKey.xml into the indicated place in
policyPublicProto.xml and delete the <D:>, <P:>, <Q:>, <DP:> and <DQ:>
elements.  Sign this file by typing:

	cd ROOT/HWRoot

  ../cryptUtility.exe -Sign policyPrivateKey.xml rsa1024-sha256-pkcspad \
    policyPublicProto.xml policyCert.xml # for 1024 bit keys
or
  ../cryptUtility.exe -Sign policyPrivateKey.xml rsa2048-sha256-pkcspad \
    policyPublicProto2048.xml policyCert.xml # for 2048 bit keys

Next, produce the include file that will be used to insert the policy cert 
in the activity elements.

../cryptUtility.exe -PolicyCert policyCert.xml policyCert.inc FileProxy
Copy policyCert.inc to Code/fileProxy and Code/tcService.

Note that the change in the include file (.inc) does not trigger a rebuild, so
you may have to manually delete the executables and rebuild.
