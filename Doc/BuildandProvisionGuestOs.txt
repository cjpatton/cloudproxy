Building and provisioning the Guest OS
======================================


Make sure your VM has at least 20MB of disk


1. Install via virt-manager a fresh VM from a CD.
    My password is Tori.

2. Download the development tools, source and 
   BuildingTrustedOS.txt and kvm.txt.

3. SSH the jlmcrypt directory into the VM.
    apt-get install openssh-server
    sudo service ssh start
    sudo stop ssh
    sudo start ssh
    sudo restart ssh
    sudo status ssh
    ssh jlm@192.168.122.244
    sftp
    put jlmcrypt.tar .

4. Save the VM Image in virtmanager.
   You can find the IP address to SSH to by going into the VM
   and typing ifconfig -a.

5. Save the original libvirt xml to a safe place.  For example,
   virsh dumpxml KvmTestGuest > /home/jlm/jlmcrypt/vms/KvmTestGuestImage.xml

6. Copy the kernel-image file and initram file for the CloudProxy
   partition to the place you want to save them.  In this example,
   I use /home/jlm/jlmcrypt/vms/kernel and /home/jlm/jlmcrypt/vms/initram.

7  Change the boot options for your vm (in virt-manager, for example)
   so that it does the direct kernel/initram boot using the files
   named in step 6.

8. Save the new libvirt xml to a safe place.  For example,
   virsh dumpxml KvmTestGuest > /home/jlm/jlmcrypt/vms/KvmTestGuestBoot.xml.

9. Copy the direct boot xml into a template file that you will reference
   when you tcLaunch the VM.  For example,
    cp /home/jlm/jlmcrypt/vms/KvmTestGuestBoot.xml /home/jlm/jlmcrypt/vms/KvmTestGuestTemplate.xml

10.Edit the template file.  
    Replace the value of the name tag (which should have the name of
    vm originally) with %s.  For example,
        <name>%s</name>
    Replace the kernel and image tag values with %s, getting
        <kernel>%s</kernel>
        <initrd>%s</initrd>
    Replace the disk source file value with %s, getting:
        <disk type='file' device='disk'>
            <driver name='qemu' type='raw'/>
            <source file='%s'/>
            <target dev='hda' bus='ide'/>
            <address type='drive' controller='0' bus='0' unit='0'/>
        </disk>






